.PHONY: help init plan apply destroy clean fmt validate output

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

help: ## æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
	@echo "Android Management API - Terraform ç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•: make [target]"
	@echo ""
	@echo "å¯ç”¨ç›®æ ‡:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

init: ## åˆå§‹åŒ– Terraform
	@echo "ğŸ”§ åˆå§‹åŒ– Terraform..."
	terraform init

plan: ## æŸ¥çœ‹å°†è¦åº”ç”¨çš„æ›´æ”¹
	@echo "ğŸ“‹ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’..."
	terraform plan

apply: ## åº”ç”¨ Terraform é…ç½®
	@echo "ğŸš€ åº”ç”¨ Terraform é…ç½®..."
	terraform apply

apply-auto: ## è‡ªåŠ¨åº”ç”¨é…ç½®(ä¸éœ€è¦ç¡®è®¤)
	@echo "ğŸš€ è‡ªåŠ¨åº”ç”¨ Terraform é…ç½®..."
	terraform apply -auto-approve

destroy: ## é”€æ¯æ‰€æœ‰ Terraform ç®¡ç†çš„èµ„æº
	@echo "âš ï¸  è­¦å‘Š: å°†é”€æ¯æ‰€æœ‰èµ„æº!"
	terraform destroy

destroy-auto: ## è‡ªåŠ¨é”€æ¯èµ„æº(ä¸éœ€è¦ç¡®è®¤)
	@echo "âš ï¸  è‡ªåŠ¨é”€æ¯æ‰€æœ‰èµ„æº..."
	terraform destroy -auto-approve

fmt: ## æ ¼å¼åŒ– Terraform é…ç½®æ–‡ä»¶
	@echo "âœ¨ æ ¼å¼åŒ– Terraform æ–‡ä»¶..."
	terraform fmt -recursive

validate: ## éªŒè¯ Terraform é…ç½®
	@echo "âœ… éªŒè¯ Terraform é…ç½®..."
	terraform validate

output: ## æ˜¾ç¤ºæ‰€æœ‰è¾“å‡º
	@echo "ğŸ“¤ æ˜¾ç¤ºè¾“å‡º..."
	terraform output

output-json: ## ä»¥ JSON æ ¼å¼æ˜¾ç¤ºè¾“å‡º
	@echo "ğŸ“¤ æ˜¾ç¤º JSON æ ¼å¼è¾“å‡º..."
	terraform output -json

show: ## æ˜¾ç¤ºå½“å‰çŠ¶æ€
	@echo "ğŸ“Š æ˜¾ç¤ºå½“å‰çŠ¶æ€..."
	terraform show

refresh: ## åˆ·æ–°çŠ¶æ€
	@echo "ğŸ”„ åˆ·æ–°çŠ¶æ€..."
	terraform refresh

graph: ## ç”Ÿæˆèµ„æºä¾èµ–å›¾
	@echo "ğŸ“ˆ ç”Ÿæˆèµ„æºä¾èµ–å›¾..."
	terraform graph | dot -Tpng > graph.png
	@echo "âœ… ä¾èµ–å›¾å·²ä¿å­˜åˆ° graph.png"

clean: ## æ¸…ç†æœ¬åœ°æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†æœ¬åœ°æ–‡ä»¶..."
	rm -rf .terraform
	rm -f .terraform.lock.hcl
	rm -f terraform.tfstate*
	rm -f graph.png
	@echo "âœ… æ¸…ç†å®Œæˆ"

test-cn: ## æµ‹è¯• CN Topic
	@echo "ğŸ§ª æµ‹è¯• CN Topic..."
	@TOPIC=$$(terraform output -raw amapi_topic_cn_name); \
	echo "å‘å¸ƒæµ‹è¯•æ¶ˆæ¯åˆ° $$TOPIC..."; \
	gcloud pubsub topics publish $$TOPIC --message="Test from Makefile - CN"
	@SUB=$$(terraform output -raw amapi_subscription_cn_name); \
	echo "ä»è®¢é˜… $$SUB æ‹‰å–æ¶ˆæ¯..."; \
	gcloud pubsub subscriptions pull $$SUB --auto-ack --limit=5

test-row: ## æµ‹è¯• ROW Topic
	@echo "ğŸ§ª æµ‹è¯• ROW Topic..."
	@TOPIC=$$(terraform output -raw amapi_topic_row_name); \
	echo "å‘å¸ƒæµ‹è¯•æ¶ˆæ¯åˆ° $$TOPIC..."; \
	gcloud pubsub topics publish $$TOPIC --message="Test from Makefile - ROW"
	@SUB=$$(terraform output -raw amapi_subscription_row_name); \
	echo "ä»è®¢é˜… $$SUB æ‹‰å–æ¶ˆæ¯..."; \
	gcloud pubsub subscriptions pull $$SUB --auto-ack --limit=5

test-all: test-cn test-row ## æµ‹è¯•æ‰€æœ‰ Topics

download-key: ## ä¸‹è½½ Service Account Key
	@echo "ğŸ”‘ ä¸‹è½½ Service Account Key..."
	@SA_EMAIL=$$(terraform output -raw service_account_email); \
	echo "Service Account: $$SA_EMAIL"; \
	gcloud iam service-accounts keys create sa-key.json --iam-account=$$SA_EMAIL
	@echo "âœ… Key å·²ä¿å­˜åˆ° sa-key.json"

setup: init ## å®Œæ•´è®¾ç½®æµç¨‹
	@echo "ğŸ“¦ åˆ›å»ºé…ç½®æ–‡ä»¶..."
	@if [ ! -f terraform.tfvars ]; then \
		cp terraform.tfvars.example terraform.tfvars; \
		echo "âš ï¸  è¯·ç¼–è¾‘ terraform.tfvars è®¾ç½®ä½ çš„ project_id"; \
	else \
		echo "âœ… terraform.tfvars å·²å­˜åœ¨"; \
	fi

check: fmt validate ## æ£€æŸ¥é…ç½®(æ ¼å¼åŒ– + éªŒè¯)
	@echo "âœ… é…ç½®æ£€æŸ¥å®Œæˆ"

