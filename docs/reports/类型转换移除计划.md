# 类型转换移除计划

## 问题分析

目前 `pkgs/amapi/types` 目录下定义了大量自定义类型（如 `Policy`, `Device`, `Enterprise`, `EnrollmentToken` 等），这些类型本质上只是 `androidmanagement` 包类型的简单包装，需要大量转换函数（`ToAMAPI*`, `FromAMAPI*`）进行转换，增加了代码复杂度和维护成本。

## 重构目标

1. **直接使用 `androidmanagement` 包的类型**，避免不必要的类型转换
2. **保留有用的辅助方法**，改为独立的 helper 函数
3. **简化代码结构**，提高可维护性

## 已完成的改动

### 1. 更新了 `pkgs/amapi/amapi.go`
- 将类型别名改为直接使用 `androidmanagement` 包的类型
- 更新了导入语句

### 2. 创建了 `pkgs/amapi/helpers.go`
- 提供了辅助函数来替代原有的类型方法
- 包含 `GetEnterpriseID`, `GetEnrollmentTokenID`, `IsEnrollmentTokenExpired` 等函数

## 需要完成的改动

### 1. 更新 client 包中的所有服务

以下文件需要更新，将所有 `*types.XXX` 改为直接使用 `*androidmanagement.XXX`：

- [ ] `pkgs/amapi/client/enrollment.go` - 约 32 处类型引用
- [ ] `pkgs/amapi/client/enterprises.go` - 约 45 处类型引用
- [ ] `pkgs/amapi/client/policies.go` - 约 25 处类型引用
- [ ] `pkgs/amapi/client/devices.go` - 约 15 处类型引用
- [ ] `pkgs/amapi/client/webapp.go` - 约 20 处类型引用
- [ ] `pkgs/amapi/client/webtoken.go` - 约 10 处类型引用
- [ ] `pkgs/amapi/client/migration.go` - 约 15 处类型引用
- [ ] `pkgs/amapi/client/provisioning.go` - 约 8 处类型引用

**主要更改模式：**
```go
// 之前
func (es *EnrollmentService) Get(tokenName string) (*types.EnrollmentToken, error) {
    result, err := ...
    return types.FromAMAPIEnrollmentToken(result), nil
}

// 之后
func (es *EnrollmentService) Get(tokenName string) (*androidmanagement.EnrollmentToken, error) {
    result, err := ...
    return result, nil  // 直接返回，无需转换
}
```

### 2. 移除所有转换函数

以下文件中的转换函数可以删除：

- `pkgs/amapi/types/common.go`: `ToAMAPIPolicy`, `FromAMAPIPolicy`, `ToAMAPIDevice`, `FromAMAPIDevice`
- `pkgs/amapi/types/enrollment.go`: `ToAMAPIEnrollmentToken`, `FromAMAPIEnrollmentToken`, `ToAMAPIUser`, `FromAMAPIUser`
- `pkgs/amapi/types/enterprise.go`: `ToAMAPIEnterprise`, `FromAMAPIEnterprise`, `ToAMAPIContactInfo`, `FromAMAPIContactInfo`, `termsToAMAPI`, `fromAMAPITerms`
- `pkgs/amapi/types/device.go`: `ToAMAPICommand`, `FromAMAPICommand`
- `pkgs/amapi/types/webapp.go`: `ToAMAPIWebApp`, `FromAMAPIWebApp`
- `pkgs/amapi/types/webtoken.go`: `ToAMAPIWebToken`, `FromAMAPIWebToken`
- `pkgs/amapi/types/migration.go`: `ToAMAPIMigrationToken`, `FromAMAPIMigrationToken`
- `pkgs/amapi/types/provisioning.go`: `ToAMAPIProvisioningInfo`, `FromAMAPIProvisioningInfo`

### 3. 更新辅助方法调用

将类型方法调用改为 helper 函数调用：

```go
// 之前
token.IsExpired()
enterprise.GetID()

// 之后
amapi.IsEnrollmentTokenExpired(token)
amapi.GetEnterpriseID(enterprise)
```

### 4. 处理请求类型

`types` 包中的请求类型（如 `EnrollmentTokenCreateRequest`）可以保留，因为它们包含验证逻辑和额外的字段。但需要更新它们使用 `androidmanagement` 类型：

- 更新 `EnrollmentTokenCreateRequest.User` 字段类型
- 更新其他请求类型中引用 `androidmanagement` 类型的字段

### 5. 更新其他使用这些类型的代码

- `pkgs/amapi/presets/policies.go` - 需要更新策略预设
- 任何测试文件
- README 和文档中的示例代码

## 注意事项

1. **保持向后兼容性**：如果这是公开 API，需要考虑是否保持类型别名以兼容现有代码
2. **辅助方法的迁移**：某些有用的方法（如 `IsExpired`, `GetID`）已迁移到 `helpers.go`
3. **请求类型**：可以保留请求/响应包装类型，因为它们提供了额外的验证和便利方法
4. **错误处理**：`types.Error` 类型可以保留，因为它提供了自定义错误处理

## 建议的迁移步骤

1. 先更新一个小的服务（如 `provisioning.go`）作为示例
2. 运行测试确保功能正常
3. 逐步迁移其他服务
4. 最后清理转换函数和未使用的类型定义

